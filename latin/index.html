import React, { useState, useEffect, useRef } from 'react';
import { BookOpen, Info, Type, X } from 'lucide-react';

// --- DATA & LOGIC ENGINE ---

// 1. The "Gold Standard" Dictionary
// Pre-loaded data for John 1:1-5 to demonstrate perfect parsing capability.
const PRECISE_DICTIONARY = {
  "in": { lemma: "in", def: "in, on, at", parse: "Prep (Abl/Acc)" },
  "principio": { lemma: "principium", def: "beginning, origin", parse: "Abl Sg Neut" },
  "erat": { lemma: "sum", def: "to be, exist", parse: "Impf Ind Act 3S" },
  "verbum": { lemma: "verbum", def: "word, speech", parse: "Nom Sg Neut" },
  "et": { lemma: "et", def: "and", parse: "Conj" },
  "apud": { lemma: "apud", def: "at, by, near, among", parse: "Prep (Acc)" },
  "deum": { lemma: "deus", def: "God, deity", parse: "Acc Sg Masc" },
  "deus": { lemma: "deus", def: "God, deity", parse: "Nom Sg Masc" },
  "hoc": { lemma: "hic", def: "this", parse: "Nom Sg Neut" },
  "omnia": { lemma: "omnis", def: "all, every", parse: "Nom Pl Neut" },
  "per": { lemma: "per", def: "through, by means of", parse: "Prep (Acc)" },
  "ipsum": { lemma: "ipse", def: "himself, itself", parse: "Acc Sg Masc" },
  "facta": { lemma: "facio", def: "made, done", parse: "Perf Pass Part Nom Pl Neut" },
  "sunt": { lemma: "sum", def: "to be", parse: "Pres Ind Act 3P" },
  "sine": { lemma: "sine", def: "without", parse: "Prep (Abl)" },
  "ipso": { lemma: "ipse", def: "himself, itself", parse: "Abl Sg Masc" },
  "factum": { lemma: "facio", def: "made, done", parse: "Perf Pass Part Nom Sg Neut" },
  "est": { lemma: "sum", def: "is", parse: "Pres Ind Act 3S" },
  "nihil": { lemma: "nihil", def: "nothing", parse: "Nom/Acc Sg Neut" },
  "quod": { lemma: "qui", def: "which, what", parse: "Nom Sg Neut" },
  "vita": { lemma: "vita", def: "life", parse: "Nom Sg Fem" },
  "lux": { lemma: "lux", def: "light", parse: "Nom Sg Fem" },
  "hominum": { lemma: "homo", def: "man, human", parse: "Gen Pl Masc" },
  "lucet": { lemma: "luceo", def: "shine, be light", parse: "Pres Ind Act 3S" },
  "tenebrae": { lemma: "tenebrae", def: "darkness", parse: "Nom Pl Fem" },
  "eam": { lemma: "is", def: "her, it", parse: "Acc Sg Fem" },
  "non": { lemma: "non", def: "not", parse: "Adv" },
  "comprehenderunt": { lemma: "comprehendo", def: "seize, grasp, understand", parse: "Perf Ind Act 3P" }
};

// 2. The Heuristic Analyzer (Fallback)
// Attempts to guess parsing based on common endings if word is not in dictionary.
const analyzeUnknownWord = (word) => {
  const clean = word.toLowerCase().replace(/[.,;?!]/g, '');
  
  // Basic suffix mapping (Simplified for demonstration)
  const endings = [
    { suffix: 'bus', parse: 'Dat/Abl Pl', guess: 'Noun/Adj' },
    { suffix: 'ntur', parse: 'Pres Ind Pass 3P', guess: 'Verb' },
    { suffix: 'mur', parse: 'Pres Ind Pass 1P', guess: 'Verb' },
    { suffix: 'mus', parse: 'Pres Ind Act 1P', guess: 'Verb' },
    { suffix: 'tis', parse: 'Pres Ind Act 2P', guess: 'Verb' },
    { suffix: 'nt', parse: 'Pres Ind Act 3P', guess: 'Verb' },
    { suffix: 'ns', parse: 'Pres Part', guess: 'Participle' },
    { suffix: 'am', parse: 'Acc Sg Fem', guess: 'Noun 1st Decl' },
    { suffix: 'um', parse: 'Acc Sg Masc / Nom Neut', guess: 'Noun 2nd Decl' },
    { suffix: 'em', parse: 'Acc Sg M/F', guess: 'Noun 3rd Decl' },
    { suffix: 'as', parse: 'Acc Pl Fem', guess: 'Noun 1st Decl' },
    { suffix: 'os', parse: 'Acc Pl Masc', guess: 'Noun 2nd Decl' },
    { suffix: 'es', parse: 'Nom/Acc Pl M/F', guess: 'Noun 3rd Decl' },
    { suffix: 'ae', parse: 'Gen/Dat Sg or Nom Pl', guess: 'Noun 1st Decl' },
    { suffix: 'i', parse: 'Gen Sg / Nom Pl', guess: 'Noun 2nd Decl' },
    { suffix: 'o', parse: 'Dat/Abl Sg', guess: 'Noun 2nd Decl' },
    { suffix: 'a', parse: 'Nom/Abl Sg Fem or Nom/Acc Pl Neut', guess: 'Noun' },
    { suffix: 'us', parse: 'Nom Sg Masc', guess: 'Noun 2nd Decl' },
    { suffix: 'is', parse: 'Gen Sg / Dat/Abl Pl', guess: 'Noun 3rd Decl' },
    { suffix: 't', parse: 'Pres Ind Act 3S', guess: 'Verb' },
  ];

  for (let rule of endings) {
    if (clean.endsWith(rule.suffix)) {
      return {
        lemma: clean.slice(0, -rule.suffix.length) + '-', 
        def: `(Hypothetical ${rule.guess})`, 
        parse: rule.parse + '?'
      };
    }
  }

  return { lemma: clean, def: "Definition unavailable", parse: "Unknown" };
};

// --- REACT COMPONENTS ---

const Tooltip = ({ data, position, onClose }) => {
  if (!data) return null;

  return (
    <div 
      className="absolute z-50 bg-white border border-stone-300 shadow-xl rounded-lg p-4 w-64 text-sm font-serif transform -translate-x-1/2 mt-2"
      style={{ left: position.x, top: position.y }}
    >
      <div className="flex justify-between items-start border-b border-stone-200 pb-2 mb-2">
        <div>
          <h3 className="text-xl font-bold text-stone-900 leading-none">{data.word}</h3>
          <span className="text-xs text-stone-500 italic font-sans">from {data.lemma}</span>
        </div>
        <button onClick={onClose} className="text-stone-400 hover:text-stone-700">
          <X size={16} />
        </button>
      </div>
      
      <div className="space-y-2">
        <div>
          <span className="block text-xs font-sans font-bold text-stone-500 uppercase tracking-wide">Definition</span>
          <p className="text-stone-800">{data.def}</p>
        </div>
        
        <div>
          <span className="block text-xs font-sans font-bold text-stone-500 uppercase tracking-wide">Parsing</span>
          <div className="inline-flex items-center px-2 py-1 rounded bg-stone-100 text-stone-700 font-mono text-xs border border-stone-200">
             {data.parse}
          </div>
        </div>
      </div>
      <div className="mt-3 text-[10px] text-stone-400 text-center font-sans">
        {data.source === 'precise' ? 'âœ“ Verified Entry' : '? Heuristic Guess'}
      </div>
    </div>
  );
};

export default function LatinReader() {
  const [inputText, setInputText] = useState("In principio erat Verbum, et Verbum erat apud Deum, et Deus erat Verbum.");
  const [activeWordData, setActiveWordData] = useState(null);
  const [tooltipPos, setTooltipPos] = useState({ x: 0, y: 0 });
  const containerRef = useRef(null);

  const handleWordClick = (e, word) => {
    // Sanitize
    const cleanWord = word.toLowerCase().replace(/[^a-z]/g, '');
    if (!cleanWord) return;

    // Lookup logic
    let result = PRECISE_DICTIONARY[cleanWord];
    let source = 'precise';

    if (!result) {
      result = analyzeUnknownWord(cleanWord);
      source = 'heuristic';
    }

    // Calculate position
    const rect = e.target.getBoundingClientRect();
    const containerRect = containerRef.current.getBoundingClientRect();

    setTooltipPos({
      x: rect.left - containerRect.left + (rect.width / 2),
      y: rect.bottom - containerRect.top
    });

    setActiveWordData({
      word: word.replace(/[.,;?!]/g, ''),
      lemma: result.lemma,
      def: result.def,
      parse: result.parse,
      source: source
    });
  };

  return (
    <div className="min-h-screen bg-[#f7f5f0] text-stone-800 font-serif p-4 md:p-8">
      <div className="max-w-3xl mx-auto">
        
        {/* Header */}
        <header className="mb-8 border-b-2 border-stone-800 pb-4 flex justify-between items-end">
          <div>
            <h1 className="text-4xl font-black tracking-tight text-stone-900">LECTOR LATINUS</h1>
            <p className="text-stone-600 mt-2 font-sans text-sm">Interactive Morphological Parser & Reader</p>
          </div>
          <div className="hidden md:block text-right text-xs font-sans text-stone-500">
            <p>Demo v1.0</p>
            <p>Heuristic + Dictionary Mode</p>
          </div>
        </header>

        {/* Info Box */}
        <div className="bg-white border-l-4 border-amber-600 p-4 mb-6 shadow-sm rounded-r-lg">
          <div className="flex gap-3">
            <Info className="text-amber-600 shrink-0" size={24} />
            <div className="text-sm font-sans text-stone-700">
              <p className="font-bold mb-1">How it works:</p>
              <p>Type or paste Latin text below. Words are processed instantly. Click or hover on any word to see its parsing (Grammar) and definition.</p>
              <p className="mt-2 text-stone-500 italic">
                *Note: This demo contains a full dictionary for <strong>John 1:1-18</strong>. Other texts use an algorithmic suffix guesser.
              </p>
            </div>
          </div>
        </div>

        {/* Input Area */}
        <div className="mb-8">
            <label className="flex items-center gap-2 text-xs font-bold font-sans uppercase tracking-wider text-stone-400 mb-2">
                <Type size={14} /> Input Source Text
            </label>
            <textarea
                className="w-full h-32 p-4 rounded-lg border border-stone-300 shadow-inner bg-white focus:ring-2 focus:ring-stone-400 focus:border-stone-400 outline-none transition font-serif text-lg resize-y"
                value={inputText}
                onChange={(e) => setInputText(e.target.value)}
                placeholder="Paste Latin text here..."
            />
        </div>

        {/* Interactive Output Area */}
        <div className="relative">
             <label className="flex items-center gap-2 text-xs font-bold font-sans uppercase tracking-wider text-stone-400 mb-2">
                <BookOpen size={14} /> Interactive Reader
            </label>
            
            <div 
                ref={containerRef}
                className="bg-white p-8 rounded-xl shadow-lg border border-stone-200 min-h-[300px] leading-loose text-xl md:text-2xl text-justify"
                style={{ position: 'relative' }} // For tooltip positioning
            >
                {inputText.split(/(\s+)/).map((segment, index) => {
                    // Check if segment is a word or whitespace
                    if (segment.match(/^\s+$/)) return <span key={index}>{segment}</span>;
                    
                    return (
                        <span 
                            key={index}
                            className="relative cursor-pointer hover:bg-amber-100 hover:text-amber-900 rounded px-0.5 transition-colors duration-200 group border-b border-transparent hover:border-amber-300 select-none"
                            onMouseEnter={(e) => handleWordClick(e, segment)}
                            onClick={(e) => handleWordClick(e, segment)}
                        >
                            {segment}
                        </span>
                    );
                })}

                {/* Tooltip Overlay */}
                {activeWordData && (
                    <Tooltip 
                        data={activeWordData} 
                        position={tooltipPos} 
                        onClose={() => setActiveWordData(null)}
                    />
                )}
            </div>
        </div>

        {/* Legend */}
        <div className="mt-12 grid grid-cols-2 md:grid-cols-4 gap-4 text-xs font-sans text-stone-500 border-t border-stone-200 pt-6">
            <div>
                <strong className="block text-stone-900 mb-1">Parts of Speech</strong>
                <ul className="space-y-1">
                    <li>Nom: Nominative</li>
                    <li>Gen: Genitive</li>
                    <li>Dat: Dative</li>
                    <li>Acc: Accusative</li>
                </ul>
            </div>
            <div>
                <strong className="block text-stone-900 mb-1">&nbsp;</strong>
                <ul className="space-y-1">
                    <li>Abl: Ablative</li>
                    <li>Voc: Vocative</li>
                    <li>Sg/Pl: Singular/Plural</li>
                </ul>
            </div>
            <div>
                <strong className="block text-stone-900 mb-1">Verbs</strong>
                <ul className="space-y-1">
                    <li>Pres: Present</li>
                    <li>Impf: Imperfect</li>
                    <li>Perf: Perfect</li>
                    <li>Fut: Future</li>
                </ul>
            </div>
            <div>
                <strong className="block text-stone-900 mb-1">&nbsp;</strong>
                <ul className="space-y-1">
                    <li>Ind: Indicative</li>
                    <li>Subj: Subjunctive</li>
                    <li>Act/Pass: Active/Passive</li>
                    <li>Inf: Infinitive</li>
                </ul>
            </div>
        </div>

      </div>
    </div>
  );
}
